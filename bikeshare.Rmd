---
title: "Stats 101A final project"
author: "Roger Wilson -- 805504529"
date: "`r format(Sys.Date(), '%D')`"
output:
  pdf_document:
    toc: yes
    toc_depth: '4'
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
header-includes:
- \usepackage{setspace}
- \doublespacing
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Setup

This data set of interest is of [**Capital Bikeshare**](https://capitalbikeshare.com/) rentals in 2011 and 2012, sourced from the [**UCI Machine Learning Repository**](https://archive.ics.uci.edu/ml/datasets/bike+sharing+dataset). From the site:\
"Bike-sharing systems represent a new generation of traditional bike rentals, where the entire process - from membership and rental to return - has become automatic. With these systems, users can easily rent a bike from a particular location and return it to another. Currently, there are over 500 bike-sharing programs worldwide, which comprise more than 500,000 bicycles. These systems are of great interest due to their important role in addressing traffic, environmental, and health issues.

In addition to the interesting real-world applications of bike-sharing systems, the characteristics of the data generated by these systems make them attractive for research. Unlike other transport services such as buses or subways, the duration of travel, departure, and arrival positions are explicitly recorded in these systems. This feature turns bike-sharing systems into a virtual sensor network that can be used for sensing mobility in the city. Therefore, it is expected that most of the important events in the city could be detected by monitoring this data."

This project will analyze bike share demand in Washington D.C. from 2011-2012. The variables can be described below:

+----------------+---------------------------------------------------------------------------------------------------------------------+
| Variable       | Description                                                                                                         |
+:===============+:====================================================================================================================+
| instant        | record index                                                                                                        |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| dteday         | date                                                                                                                |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| season         | season (1:winter, 2:spring, 3:summer, 4:fall)                                                                       |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| yr             | year (0: 2011, 1:2012)                                                                                              |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| mnth           | month ( 1 to 12)                                                                                                    |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| hr             | hour (0 to 23)                                                                                                      |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| holiday        | weather day is holiday or not                                                                                       |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| weekday        | day of the week                                                                                                     |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| workingday     | if day is neither weekend nor holiday is 1, otherwise is 0                                                          |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| weathersit     | 1: Clear, Few clouds, Partly cloudy, Partly cloudy.                                                                 |
|                |                                                                                                                     |
|                | 2: Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist.                                                    |
|                |                                                                                                                     |
|                | 3: Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds.                         |
|                |                                                                                                                     |
|                | 4: Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog                                                       |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| temp           | Normalized temperature in Celsius. The values are derived via (t-t_min)/(t_max-t_min), t_min=-8, t_max=+39          |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| atemp          | Normalized feeling temperature in Celsius. The values are derived via (t-t_min)/(t_max-t_min), t_min=-16, t_max=+50 |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| hum            | Normalized humidity. The values are divided to 100 (max)                                                            |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| windspeed      | Normalized wind speed. The values are divided to 67 (max)                                                           |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| casual         | count of casual users                                                                                               |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| registered     | count of registered users                                                                                           |
+----------------+---------------------------------------------------------------------------------------------------------------------+
| cnt            | count of total rental bikes including both casual and registered                                                    |
+----------------+---------------------------------------------------------------------------------------------------------------------+

The index will be excluded from the model.

\pagebreak

## Exploratory Analysis

```{r, warning=FALSE,message=FALSE}
bikes <- read.csv("day.csv", header = TRUE)
bikes$dteday <- as.Date(bikes$dteday)
bikes <- bikes[, -1]
summary(bikes)
```

```{r, message=FALSE}
bikes[, c(2, 4, 6, 8)] <- lapply(bikes[, c(2, 4, 6, 8)], factor)
```

\pagebreak

```{r, fig.height=30, fig.width=20,fig.align='center', warning=FALSE,message=FALSE}
library(ggplot2)
library(gridExtra)

# Create empty list to store plots
plots <- list()

# Loop through columns of bikes data frame
for (col in names(bikes)) {
  if (col %in% c("season", "yr", "mnth", "holiday", "weekday",
                 "workingday", "weathersit")) {
    p <- ggplot(bikes, aes(x = .data[[col]])) +
    geom_bar(fill = "#F26419") + theme_classic() + labs(x = col)
  }
  else  {
    p <- ggplot(bikes, aes(x = .data[[col]])) +
    geom_histogram(fill = "#F26419") + theme_classic() + labs(x = col)
  }
  plots[[col]] <- p
}

# Arrange plots in a grid
grid.arrange(grobs = plots, ncol = 3)
```

\pagebreak

```{r, fig.height=30, fig.width=20, fig.align='center', message=FALSE, warning=FALSE}
# Function to add correlation coefficients
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...) {
    usr <- par("usr")
    on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    Cor <- abs(cor(x, y)) # Remove abs function if desired
    txt <- paste0(prefix, format(c(Cor, 0.123456789), digits = digits)[1])
    if(missing(cex.cor)) {
        cex.cor <- 0.4 / strwidth(txt)
    }
    text(0.5, 0.5, txt,
         cex = 2) # Resize the text by level of correlation
}

# Plotting the correlation matrix
pairs(bikes[, c(1, 4, 6, 9:15)],
      pch = 20, 
      col = "#1F7A8C", 
      gap = 0,
      upper.panel = panel.cor,    # Correlation panel
      lower.panel = panel.smooth) # Smoothed regression lines
```

There is very few skewness in our variables. There are overwhelmingly more non-holidays to holidays and sunny / cloudy days to rainy days: there are also no recorded days of snow. The total count of rented bikes is equal to the sum of casual riders and registered riders, and it's interesting that casual riders is right skewed.\
In the correlation plots, it seems that weather-related factors such as temperature and conditions have the largest effect on the total number of rented bikes. Casual and registered, being directly related to the total, will be excluded from our models. It would be interesting to test models on these in future projects for comparison.\
There does not seem to be severe collinearity between the variables, besides obviously temperature and perceived temperature.\
Year should also be removed from the analysis: This model will be focusing on predicting the number rented bikes based on a single day's conditions, and there is not as much interest in differences between 2011 and 2012 numbers.

\pagebreak

## Original Model

We are just going to throw the kitchen sink at this data.

```{r}
summary(model <- lm(cnt ~ .  - yr - casual - registered 
                    - workingday, 
                    data = bikes))
```

This original model has an adjusted R-squared value of 0.8402. Most of the variables are statistically significant, besides a few factored months and perceived temperature. 
\pagebreak

```{r, fig.height=6,fig.width=6,fig.align='center', warning=FALSE,message=FALSE}
par(mfrow=c(2,2))
plot(model, pch = 20, col = "#248232", lwd = 2)
```

These plots look ok. There is one point with high leverage, but doesn't have necessarily a high Cook's value. Some of the standardized residuals are left-skewed in the Q-Q plot. 

```{r, message=FALSE}
library(car)
vif(model)
```

However, we have VERY high variance inflation between our variables. This makes sense, particularly the relationship between `temp` and `atemp`, as well as between the weather during various seasons and months. We will remove these before performing forward feature selection.

## Feature Selection

```{r}
model <- lm(cnt ~ . -yr - casual - registered - workingday 
            - mnth - temp, data = bikes)
```

from Miles Chen 101A Nov 20 2015 youtube lecture:
```{r, message=FALSE}
# from Miles Chen 101A Nov 20 2015 youtube lecture
attach(bikes)
X <- cbind(dteday, season, holiday, weekday, weathersit,
           atemp, hum, windspeed)
library(leaps)
b <- regsubsets(as.matrix(X), cnt)
rs <- summary(b)
rs
detach(bikes)
```

```{r fig.height=10, fig.width=20, fig.align='center', message=FALSE}
plot(1:8, rs$adjr2, xlab = "number of features", 
     main = "exhausted algorithm selection results", 
     pch = 15, cex = 4, col = "#01BAEF")
```
It seems that a model with even just 3 variables would perform pretty well, and $R^2$ doesn't increase by much after that. It seems like date, day of the week, the weather and temperature have the greatest influence.

We'll use backward elimination to see if there's any differences.
```{r}
backwardAIC <- step(model, direction = "backward")
```

```{r}
mint = lm(cnt ~ 1, data = bikes)
forwardAIC <- step(mint, scope = list(upper = model, 
                                      lower = ~1),
                   direction = "forward")
```
We get the same results. So, we'll keep the forward AIC model.
```{r}
summary(forwardAIC)
```
Our Adjusted R-Squared is a bit lower at 0.7914, but all of our coefficients are statistically significant and there is no issues with multicolinearity.

\pagebreak

```{r, fig.height=10, fig.width=20, fig.align='center', message=FALSE}
library(car)
avPlots(forwardAIC, pch = 20, col = "#000022", col.lines = "#D81159")
```

\pagebreak
```{r, fig.height=6,fig.width=6,fig.align='center', warning=FALSE,message=FALSE}
par(mfrow=c(2,2))
plot(forwardAIC, pch = 20, col = "#248232", lwd = 2)
```

No issues with our model plots.

\pagebreak
```{r, fig.height=10, fig.width=20, fig.align='center', message=FALSE}
plot(forwardAIC$fitted, bikes$cnt, xlab = "Fitted Values", ylab = "Rent Count",
     pch = 20, col = "#7D70BA", cex = 2)
abline(lsfit(model$fitted.values, bikes$cnt), col = "#040404", lwd = 2)
```

Our fitted values are looking good too.

\pagebreak
## Reflection

```{r}
summary(model <- forwardAIC)
```
Our final model predicts the number of rented bikes based on the date, temperature feel, season, humidity, day of the week, and holiday status. 
```{r}
model$coefficients
```
Perceived temperature has the greatest influence on number of bikes rented: when we ran our regression subsets test, it was the very first variable chosen. A 1 degree (F) increase in the temperature correspond to 5,596 bikes rented!  
Number of rented bikes also depends a fair amount on the day of the week: the farther into the week, the more predicted bikes rented.  
The greatest negative influences on rental count are rain (weathersit3), high windspeed, high humidity, and holidays. These all make sense.  
In all, 79% of the variation in total rented bike counts can be attributed to these variables. We can see that from our regressions subset test that a model with just the date, weather situation and temperature serves well enough, but if we have access to all of these variables, we might as well use them.  
This project can prove helpful for cities that want to adopt a rental bike system and help plan accordingly for total number of stations and bikes needed. The D.C. bike company could also vary prices based on these variables to maximize profits or maximize number of bikes used for certain days or periods.  
This model only predicts total number of bikes rented per day. Future analysis on hourly rental counts or location-based rental information could be interesting. It would also be interesting to create models for casual rentals and registered rentals. We assumed that there was no difference in rental preferences for the sake of this project.

\pagebreak
## Appendix: All code for this report

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
